name: CI

on:
  push:
  pull_request:

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -e .

      - name: Echo smoke gate
        run: |
          echo "make test-smoke"

      - name: Run smoke tests (CPU-only)
        env:
          TRANSCRIPTX_USE_EMOJIS: "0"
          TRANSCRIPTX_DISABLE_DOWNLOADS: "1"
        run: |
          make test-smoke

      - name: Echo contract gate
        run: |
          echo "make test-contracts"

      - name: Run contract tests
        env:
          TRANSCRIPTX_USE_EMOJIS: "0"
          TRANSCRIPTX_DISABLE_DOWNLOADS: "1"
        run: |
          make test-contracts

      - name: Echo fast gate
        run: |
          echo "make test-fast"

      - name: Run fast core tests (Gate B)
        env:
          TRANSCRIPTX_USE_EMOJIS: "0"
          TRANSCRIPTX_DISABLE_DOWNLOADS: "1"
        run: |
          make test-fast

  build_sanity:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Build wheel
        run: |
          python -m pip install -U pip build
          python -m build

      - name: Install wheel in fresh venv
        run: |
          python -m venv .venv-build
          . .venv-build/bin/activate
          python -m pip install -U pip
          pip install -r requirements.txt
          pip install dist/*.whl
          python -c "import transcriptx; print(transcriptx.__version__)"
          transcriptx --help
          transcriptx analyze --help
      - name: Run minimal analysis (install verification)
        env:
          TRANSCRIPTX_USE_EMOJIS: "0"
          TRANSCRIPTX_DISABLE_DOWNLOADS: "1"
        run: |
          . .venv-build/bin/activate
          transcriptx analyze -t tests/fixtures/mini_transcriptx.json --modules stats --skip-confirm

  docker_smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set Docker buildx
        run: docker buildx version || true

      - name: Build transcriptx image
        run: |
          VERSION=$(grep -E '^version\s*=' pyproject.toml | sed -E 's/.*=\s*["\"]?([^"\"]+)["\"]?/\1/')
          docker build \
            --build-arg GIT_SHA=$(git rev-parse HEAD) \
            --build-arg TRANSCRIPTX_VERSION="${VERSION}" \
            --build-arg BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
            -t transcriptx:smoke \
            .

      - name: Docker run smoke (minimal analysis)
        env:
          TRANSCRIPTX_USE_EMOJIS: "0"
          TRANSCRIPTX_DISABLE_DOWNLOADS: "1"
        run: |
          docker run --rm \
            -v "$PWD/tests/fixtures:/fixtures:ro" \
            -e TRANSCRIPTX_USE_EMOJIS=0 \
            -e TRANSCRIPTX_DISABLE_DOWNLOADS=1 \
            transcriptx:smoke \
            analyze -t /fixtures/mini_transcriptx.json --modules stats --skip-confirm

  docker_compose_smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Build transcriptx image
        run: docker build -t transcriptx:latest .

      - name: Prepare data layout for compose
        run: |
          mkdir -p data/transcripts data/outputs
          cp tests/fixtures/mini_transcriptx.json data/transcripts/

      - name: Compose smoke (one service, one analyze)
        env:
          TRANSCRIPTX_USE_EMOJIS: "0"
          TRANSCRIPTX_DISABLE_DOWNLOADS: "1"
        run: |
          docker compose run --rm \
            -e TRANSCRIPTX_USE_EMOJIS=0 \
            -e TRANSCRIPTX_DISABLE_DOWNLOADS=1 \
            transcriptx \
            analyze -t /data/transcripts/mini_transcriptx.json --modules stats --skip-confirm

  security_scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Gitleaks scan
        uses: gitleaks/gitleaks-action@v2

  quarantine_report:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Check quarantined count
        run: |
          python - <<'PY'
          from pathlib import Path
          import re
          import os
          import sys

          tests_root = Path("tests")
          pattern = re.compile(r"pytest\.mark\.quarantined")
          count = 0
          for path in tests_root.rglob("test_*.py"):
            text = path.read_text(encoding="utf-8")
            count += len(pattern.findall(text))

          baseline_path = Path("tests/quarantine/COUNT")
          baseline = int(baseline_path.read_text().strip()) if baseline_path.exists() else 0

          ref = os.getenv("GITHUB_REF", "")
          is_main = ref == "refs/heads/main"

          print(f"Quarantined tests: {count} (baseline {baseline})")
          if count > baseline:
            msg = "Quarantined count increased."
            if is_main:
              print(msg)
              sys.exit(1)
            else:
              print("WARNING:", msg)
          PY
